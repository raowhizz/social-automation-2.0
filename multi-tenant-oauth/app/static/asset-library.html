<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Asset Library</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Navigation Header */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .navbar-menu {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: #555;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: #667eea;
        }

        .nav-link.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .app-container {
            display: flex;
            height: calc(100vh - 57px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
        }

        .sidebar-header h1 {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: #666;
        }

        .folder-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .folder-item {
            padding: 10px 15px;
            margin: 2px 0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .folder-item:hover {
            background: #f5f7fa;
        }

        .folder-item.active {
            background: #667eea;
            color: white;
        }

        .folder-icon {
            font-size: 18px;
        }

        .folder-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .folder-count {
            font-size: 12px;
            opacity: 0.7;
        }

        .add-folder-btn {
            margin: 10px;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .add-folder-btn:hover {
            background: #5568d3;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .upload-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: #5568d3;
        }

        .filter-tags {
            display: flex;
            gap: 10px;
            padding: 15px 30px;
            background: white;
            border-bottom: 1px solid #e1e8ed;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 6px 12px;
            background: #f5f7fa;
            border: 1px solid #e1e8ed;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tag:hover {
            background: #e1e8ed;
        }

        .filter-tag.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Asset Grid */
        .asset-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .asset-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .asset-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        }

        .asset-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f5f7fa;
        }

        .asset-info {
            padding: 12px;
        }

        .asset-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            justify-content: space-between;
        }

        .asset-tags {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .asset-tag {
            padding: 2px 8px;
            background: #f5f7fa;
            border-radius: 10px;
            font-size: 11px;
            color: #666;
        }

        /* Upload Drop Zone */
        .drop-zone {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .drop-zone.active {
            display: flex;
        }

        .drop-zone-content {
            text-align: center;
        }

        .drop-zone-content h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .close-btn:hover {
            background: #f5f7fa;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 8px;
        }

        .preview-details {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .detail-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            margin-bottom: 8px;
        }

        .detail-group input,
        .detail-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .detail-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .tag-input-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 8px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            min-height: 40px;
        }

        .tag-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 13px;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }

        .tag-new-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            font-size: 14px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #f5f7fa;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e1e8ed;
        }

        .usage-stats {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: #f5f7fa;
            border-radius: 6px;
        }

        .usage-stat {
            text-align: center;
        }

        .usage-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .usage-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="navbar-brand">üçï Restaurant Social Automation</div>
        <div class="navbar-menu">
            <a href="/ui" class="nav-link">Dashboard</a>
            <a href="/ui/suggestions" class="nav-link">Post Ideas</a>
            <a href="/ui/calendar" class="nav-link">Calendar</a>
            <a href="/ui/create" class="nav-link">Create Post</a>
            <a href="/ui/config" class="nav-link">Config</a>
            <a href="/ui/assets" class="nav-link active">Assets</a>
        </div>
    </nav>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Brand Assets</h1>
                <p id="tenant-name">Loading...</p>
            </div>
            <div class="folder-tree" id="folderTree">
                <div class="spinner"></div>
            </div>
            <button class="add-folder-btn" onclick="createFolder()">+ New Folder</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Search assets by name, description, or tags..."
                           onkeyup="debounceSearch()">
                </div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <span>üì§</span> Upload Assets
                </button>
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none"
                       onchange="handleFileUpload(event)">
            </div>

            <!-- Filter Tags -->
            <div class="filter-tags" id="filterTags"></div>

            <!-- Asset Grid -->
            <div class="asset-grid-container">
                <div id="assetGrid" class="asset-grid">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drop Zone -->
    <div class="drop-zone" id="dropZone">
        <div class="drop-zone-content">
            <h2>üìÅ Drop files here to upload</h2>
            <p>Release to start uploading</p>
        </div>
    </div>

    <!-- Asset Preview Modal -->
    <div class="modal" id="assetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Asset Details</h2>
                <button class="close-btn" onclick="closeAssetModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="preview-section">
                    <div>
                        <img id="previewImage" class="preview-image" src="" alt="Asset preview">
                        <div class="usage-stats" style="margin-top: 20px;">
                            <div class="usage-stat">
                                <div class="usage-value" id="timesUsed">0</div>
                                <div class="usage-label">Times Used</div>
                            </div>
                            <div class="usage-stat">
                                <div class="usage-value" id="lastUsed">Never</div>
                                <div class="usage-label">Last Used</div>
                            </div>
                        </div>
                    </div>
                    <div class="preview-details">
                        <div class="detail-group">
                            <label>Title</label>
                            <input type="text" id="assetTitle" placeholder="Enter title...">
                        </div>
                        <div class="detail-group">
                            <label>Description</label>
                            <textarea id="assetDescription" placeholder="Enter description..."></textarea>
                        </div>
                        <div class="detail-group">
                            <label>Tags</label>
                            <div class="tag-input-container" id="tagContainer" onclick="focusTagInput()">
                                <input type="text" id="tagInput" class="tag-new-input"
                                       placeholder="Add tags..." onkeypress="handleTagInput(event)">
                            </div>
                        </div>
                        <div class="detail-group">
                            <label>Folder</label>
                            <select id="assetFolder" style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 6px;">
                                <option value="">Root</option>
                            </select>
                        </div>
                        <div class="detail-group">
                            <label>File Info</label>
                            <div style="font-size: 13px; color: #666;">
                                <div id="fileSize"></div>
                                <div id="fileDimensions"></div>
                                <div id="fileType"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteAsset()">Delete</button>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeAssetModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveAssetChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTenantId = null;
        let currentFolderId = null;
        let currentAssetId = null;
        let allAssets = [];
        let allFolders = [];
        let currentTags = [];
        let searchTimeout = null;

        // API Base URL
        const API_BASE = window.location.origin + '/api/v1';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Get tenant ID from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            currentTenantId = urlParams.get('tenant_id') || localStorage.getItem('tenant_id');

            if (!currentTenantId) {
                alert('Please provide a tenant ID');
                return;
            }

            localStorage.setItem('tenant_id', currentTenantId);
            await loadFolders();
            await loadAssets();
            setupDragAndDrop();
        });

        // Load Folders
        async function loadFolders() {
            try {
                const response = await fetch(`${API_BASE}/folders/${currentTenantId}`);
                const data = await response.json();
                allFolders = data.folders || [];
                renderFolderTree(allFolders);
                populateFolderSelect(allFolders);
            } catch (error) {
                console.error('Error loading folders:', error);
                document.getElementById('folderTree').innerHTML =
                    '<div class="empty-state"><p>Error loading folders</p></div>';
            }
        }

        // Render Folder Tree
        function renderFolderTree(folders) {
            const container = document.getElementById('folderTree');
            container.innerHTML = `
                <div class="folder-item ${!currentFolderId ? 'active' : ''}" onclick="selectFolder(null)">
                    <span class="folder-icon">üìÅ</span>
                    <span class="folder-name">All Assets</span>
                    <span class="folder-count">${allAssets.length}</span>
                </div>
            `;

            folders.forEach(folder => {
                const isActive = currentFolderId === folder.id;
                const item = document.createElement('div');
                item.className = `folder-item ${isActive ? 'active' : ''}`;
                item.onclick = () => selectFolder(folder.id);
                item.innerHTML = `
                    <span class="folder-icon">${folder.is_default === 'Y' ? 'üìÇ' : 'üìÅ'}</span>
                    <span class="folder-name">${folder.name}</span>
                    <span class="folder-count">${folder.asset_count || 0}</span>
                `;
                container.appendChild(item);

                // Render subfolders if any
                if (folder.subfolders && folder.subfolders.length > 0) {
                    folder.subfolders.forEach(subfolder => {
                        const subItem = document.createElement('div');
                        subItem.className = `folder-item ${currentFolderId === subfolder.id ? 'active' : ''}`;
                        subItem.style.paddingLeft = '35px';
                        subItem.onclick = () => selectFolder(subfolder.id);
                        subItem.innerHTML = `
                            <span class="folder-icon">üìÅ</span>
                            <span class="folder-name">${subfolder.name}</span>
                            <span class="folder-count">${subfolder.asset_count || 0}</span>
                        `;
                        container.appendChild(subItem);
                    });
                }
            });
        }

        // Populate folder select in modal
        function populateFolderSelect(folders, selectId = 'assetFolder') {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Root</option>';

            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);

                if (folder.subfolders && folder.subfolders.length > 0) {
                    folder.subfolders.forEach(subfolder => {
                        const subOption = document.createElement('option');
                        subOption.value = subfolder.id;
                        subOption.textContent = `  ${subfolder.name}`;
                        select.appendChild(subOption);
                    });
                }
            });
        }

        // Select Folder
        function selectFolder(folderId) {
            currentFolderId = folderId;
            renderFolderTree(allFolders);
            loadAssets();
        }

        // Load Assets
        async function loadAssets() {
            try {
                const searchQuery = document.getElementById('searchInput').value;
                let url = `${API_BASE}/assets?tenant_id=${currentTenantId}&limit=500`;

                if (currentFolderId) {
                    url += `&folder_id=${currentFolderId}`;
                }

                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }

                const response = await fetch(url);
                allAssets = await response.json();

                renderAssets(allAssets);
                extractAndRenderTags(allAssets);
            } catch (error) {
                console.error('Error loading assets:', error);
                document.getElementById('assetGrid').innerHTML =
                    '<div class="empty-state"><h3>Error loading assets</h3><p>Please try again</p></div>';
            }
        }

        // Helper function to convert full URL to relative path
        // Fixes ngrok authentication issues by using relative URLs
        function getRelativeImagePath(fullUrl) {
            if (!fullUrl) return '';
            // Extract path from URL (e.g., /uploads/images/...)
            try {
                const url = new URL(fullUrl);
                return url.pathname;
            } catch (e) {
                // If it's already a relative path, return as-is
                return fullUrl;
            }
        }

        // Render Assets
        function renderAssets(assets) {
            const grid = document.getElementById('assetGrid');

            if (assets.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì∑</div>
                        <h3>No assets found</h3>
                        <p>Upload images to get started</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = assets.map(asset => `
                <div class="asset-card" onclick="openAssetModal('${asset.id}')">
                    <img class="asset-thumbnail" src="${getRelativeImagePath(asset.file_url)}" alt="${asset.title || asset.filename}">
                    <div class="asset-info">
                        <div class="asset-title">${asset.title || asset.filename}</div>
                        <div class="asset-meta">
                            <span>${formatFileSize(asset.file_size)}</span>
                            <span>${asset.width}√ó${asset.height}</span>
                        </div>
                        ${asset.tags && asset.tags.length > 0 ? `
                            <div class="asset-tags">
                                ${asset.tags.slice(0, 3).map(tag => `<span class="asset-tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Extract and render filter tags
        function extractAndRenderTags(assets) {
            const tagSet = new Set();
            assets.forEach(asset => {
                if (asset.tags) {
                    asset.tags.forEach(tag => tagSet.add(tag));
                }
            });

            const container = document.getElementById('filterTags');
            if (tagSet.size === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = Array.from(tagSet).map(tag =>
                `<span class="filter-tag" onclick="toggleTagFilter('${tag}')">${tag}</span>`
            ).join('');
        }

        // Toggle tag filter
        function toggleTagFilter(tag) {
            const element = event.target;
            element.classList.toggle('active');

            const activeTags = Array.from(document.querySelectorAll('.filter-tag.active'))
                .map(el => el.textContent);

            if (activeTags.length === 0) {
                renderAssets(allAssets);
            } else {
                const filtered = allAssets.filter(asset =>
                    asset.tags && asset.tags.some(t => activeTags.includes(t))
                );
                renderAssets(filtered);
            }
        }

        // Debounce search
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadAssets();
            }, 500);
        }

        // Open Asset Modal
        async function openAssetModal(assetId) {
            currentAssetId = assetId;
            const asset = allAssets.find(a => a.id === assetId);

            if (!asset) return;

            document.getElementById('previewImage').src = getRelativeImagePath(asset.file_url);
            document.getElementById('assetTitle').value = asset.title || '';
            document.getElementById('assetDescription').value = asset.description || '';
            document.getElementById('assetFolder').value = asset.folder_id || '';
            document.getElementById('timesUsed').textContent = asset.times_used || 0;
            document.getElementById('lastUsed').textContent = asset.last_used_at
                ? new Date(asset.last_used_at).toLocaleDateString()
                : 'Never';
            document.getElementById('fileSize').textContent = `Size: ${formatFileSize(asset.file_size)}`;
            document.getElementById('fileDimensions').textContent = `Dimensions: ${asset.width}√ó${asset.height}`;
            document.getElementById('fileType').textContent = `Type: ${asset.mime_type}`;

            currentTags = asset.tags || [];
            renderTags();

            document.getElementById('assetModal').classList.add('active');
        }

        // Close Asset Modal
        function closeAssetModal() {
            document.getElementById('assetModal').classList.remove('active');
            currentAssetId = null;
            currentTags = [];
        }

        // Render Tags in Modal
        function renderTags() {
            const container = document.getElementById('tagContainer');
            const input = document.getElementById('tagInput');
            container.innerHTML = '';

            currentTags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag-item';
                tagEl.innerHTML = `${tag} <span class="tag-remove" onclick="removeTag('${tag}')">√ó</span>`;
                container.appendChild(tagEl);
            });

            container.appendChild(input);
        }

        // Handle Tag Input
        function handleTagInput(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                const input = document.getElementById('tagInput');
                const tag = input.value.trim().replace(',', '');

                if (tag && !currentTags.includes(tag)) {
                    currentTags.push(tag);
                    renderTags();
                }

                input.value = '';
            }
        }

        // Remove Tag
        function removeTag(tag) {
            currentTags = currentTags.filter(t => t !== tag);
            renderTags();
        }

        // Focus Tag Input
        function focusTagInput() {
            document.getElementById('tagInput').focus();
        }

        // Save Asset Changes
        async function saveAssetChanges() {
            if (!currentAssetId) return;

            const data = {
                title: document.getElementById('assetTitle').value,
                description: document.getElementById('assetDescription').value,
                tags: currentTags,
                folder_id: document.getElementById('assetFolder').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/assets/${currentAssetId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeAssetModal();
                    await loadAssets();
                    await loadFolders();
                    alert('Asset updated successfully!');
                } else {
                    alert('Failed to update asset');
                }
            } catch (error) {
                console.error('Error updating asset:', error);
                alert('Error updating asset');
            }
        }

        // Delete Asset
        async function deleteAsset() {
            if (!currentAssetId) return;

            if (!confirm('Are you sure you want to delete this asset? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/assets/${currentAssetId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeAssetModal();
                    await loadAssets();
                    await loadFolders();
                    alert('Asset deleted successfully!');
                } else {
                    alert('Failed to delete asset');
                }
            } catch (error) {
                console.error('Error deleting asset:', error);
                alert('Error deleting asset');
            }
        }

        // Handle File Upload
        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            await uploadFiles(files);
            event.target.value = ''; // Reset input
        }

        // Upload Files
        async function uploadFiles(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('tenant_id', currentTenantId);

                if (currentFolderId) {
                    formData.append('folder_id', currentFolderId);
                }

                try {
                    const response = await fetch(`${API_BASE}/assets/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to upload ${file.name}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`Failed to upload ${file.name}`);
                }
            }

            await loadAssets();
            await loadFolders();
            alert('Upload complete!');
        }

        // Setup Drag and Drop
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');

            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });

            document.addEventListener('dragleave', (e) => {
                if (e.target === document.body || e.target === dropZone) {
                    dropZone.classList.remove('active');
                }
            });

            document.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');

                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (files.length > 0) {
                    await uploadFiles(files);
                }
            });
        }

        // Create Folder
        async function createFolder() {
            const name = prompt('Enter folder name:');
            if (!name) return;

            const description = prompt('Enter folder description (optional):');

            try {
                const response = await fetch(`${API_BASE}/folders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: currentTenantId,
                        name: name,
                        description: description
                    })
                });

                if (response.ok) {
                    await loadFolders();
                    alert('Folder created successfully!');
                } else {
                    alert('Failed to create folder');
                }
            } catch (error) {
                console.error('Error creating folder:', error);
                alert('Error creating folder');
            }
        }

        // Utility function
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown';
            const kb = bytes / 1024;
            if (kb < 1024) return `${kb.toFixed(1)} KB`;
            return `${(kb / 1024).toFixed(1)} MB`;
        }
    </script>
</body>
</html>
